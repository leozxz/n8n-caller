document.addEventListener("DOMContentLoaded", function () {
    const Postmonger = window.Postmonger;
    var connection = new Postmonger.Session();
    var payload = {};
    var webhookUrl = "";

    const webhookInput = document.getElementById("webhookUrl");
    const saveButton = document.getElementById("save");
    const doneButton = document.getElementById("done");

    if (!webhookInput || !saveButton || !doneButton) {
        console.error("‚ùå Erro: Elementos do DOM n√£o foram encontrados.");
        return;
    }

    // Evento que recebe a atividade inicial
    connection.on('initActivity', function (data) {
        console.log("Payload recebido:", data);
        payload = data || {};

        if (payload.arguments?.execute?.inArguments) {
            webhookUrl = payload.arguments.execute.inArguments.find(arg => arg.webhookUrl)?.webhookUrl || "";
        } else {
            console.warn("‚ö†Ô∏è inArguments n√£o encontrado no payload. Criando um valor padr√£o.");
            webhookUrl = "";
            payload.arguments = payload.arguments || {};
            payload.arguments.execute = payload.arguments.execute || {};
            payload.arguments.execute.inArguments = [{}];
        }

        webhookInput.value = webhookUrl;
        connection.trigger('ready');
    });

    // Atualiza os dados ao clicar no bot√£o "Salvar"
    saveButton.addEventListener('click', function () {
        webhookUrl = webhookInput.value;

        var activityPayload = {
            name: payload.name || "Enviar para Webhook",
            id: payload.id || null,
            key: payload.key || "REST-1",
            type: "REST",
            configurationArguments: {
                publish: { inArguments: [{ webhookUrl: webhookUrl }] },
                validate: { inArguments: [{ webhookUrl: webhookUrl }] }
            },
            arguments: {
                execute: {
                    inArguments: [{ webhookUrl: webhookUrl }],
                    outArguments: []
                }
            }
        };

        console.log("üì¢ Enviando updateActivity:", activityPayload);
        connection.trigger('updateActivity', activityPayload);
    });

    // Quando o usu√°rio clica em "Done"
    doneButton.addEventListener('click', function () {
        console.log("‚úÖ Atividade configurada com sucesso!");
        connection.trigger('validateActivity');
    });
});
